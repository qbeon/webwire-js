!function(e,r){"object"==typeof exports&&"object"==typeof module?module.exports=r(require("http")):"function"==typeof define&&define.amd?define(["http"],r):"object"==typeof exports?exports["webwire-js"]=r(require("http")):e["webwire-js"]=r(e.http)}(this,function(e){return function(e){var r={};function n(t){if(r[t])return r[t].exports;var o=r[t]={i:t,l:!1,exports:{}};return e[t].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=e,n.c=r,n.d=function(e,r,t){n.o(e,r)||Object.defineProperty(e,r,{enumerable:!0,get:t})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,r){if(1&r&&(e=n(e)),8&r)return e;if(4&r&&"object"==typeof e&&e&&e.__esModule)return e;var t=Object.create(null);if(n.r(t),Object.defineProperty(t,"default",{enumerable:!0,value:e}),2&r&&"string"!=typeof e)for(var o in e)n.d(t,o,function(r){return e[r]}.bind(null,o));return t},n.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(r,"a",r),r},n.o=function(e,r){return Object.prototype.hasOwnProperty.call(e,r)},n.p="",n(n.s=15)}([function(e,r,n){"use strict";n.d(r,"b",function(){return t}),n.d(r,"a",function(){return o});var t={ErrorReply:0,ReplyShutdown:1,ReplyInternalError:2,SessionNotFound:3,MaxSessConnsReached:4,SessionsDisabled:5,ReplyProtocolError:6,SessionCreated:21,SessionClosed:22,CloseSession:31,RestoreSession:32,SignalBinary:63,SignalUtf8:64,SignalUtf16:65,RequestBinary:127,RequestUtf8:128,RequestUtf16:129,ReplyBinary:191,ReplyUtf8:192,ReplyUtf16:193},o={Signal:3,SignalUtf16:4,Request:11,RequestUtf16:12,Reply:9,ReplyUtf16:10,ErrorReply:11,ReplyShutdown:9,ReplyInternalError:9,SessionNotFound:9,MaxSessConnsReached:9,SessionsDisabled:9,ReplyProtocolError:9,RestoreSession:10,CloseSession:9,SessionCreated:2,SessionClosed:1}},function(e,r,n){e.exports=n(16)},function(e,r,n){"use strict";function t(e){var r,n,t,o,a,i;for(r="",t=e.length,n=0;n<t;)switch((o=e[n++])>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:r+=String.fromCharCode(o);break;case 12:case 13:a=e[n++],r+=String.fromCharCode((31&o)<<6|63&a);break;case 14:a=e[n++],i=e[n++],r+=String.fromCharCode((15&o)<<12|(63&a)<<6|(63&i)<<0)}return r}n.d(r,"a",function(){return t})},function(e,r,n){"use strict";function t(e){var r;r=new ArrayBuffer(e.length);for(var n=new Uint8Array(r),t=0;t<e.length;t++){var o=e.charCodeAt(t);if(o<32||o>126)throw new Error("Unsupported session key character (".concat(o,")"));n[t]=o}Object.defineProperty(this,"bytes",{get:function(){return n}}),Object.defineProperty(this,"string",{get:function(){return e}})}n.d(r,"a",function(){return t})},function(e,r,n){"use strict";n.d(r,"a",function(){return o});var t=new a(0,0);function o(){t.increment();var e=t.frags;return new a(e.front,e.end)}function a(e,r){var n=new ArrayBuffer(8),t=new Uint32Array(n,0,2);t.set([e,r],0),Object.defineProperty(this,"frags",{get:function(){return{front:t[0],end:t[1]}}}),Object.defineProperty(this,"bytes",{get:function(){return new Uint8Array(n)}}),Object.defineProperty(this,"increment",{value:function(){var e=t[0],r=t[1];r+1>4294967295?(e+1>4294967295&&(r=0,e=0),r=0,e++):r++,t.set([e,r],0)}})}},function(e,r,n){"use strict";function t(e){for(var r=[],n=0;n<e.length;n++){var t=e.charCodeAt(n);t<128?r.push(t):t<2048?r.push(192|t>>6,128|63&t):t<55296||t>=57344?r.push(224|t>>12,128|t>>6&63,128|63&t):(n++,t=65536+((1023&t)<<10|1023&e.charCodeAt(n)),r.push(240|t>>18,128|t>>12&63,128|t>>6&63,128|63&t))}return r}n.d(r,"a",function(){return t})},function(e,r){var n,t,o=e.exports={};function a(){throw new Error("setTimeout has not been defined")}function i(){throw new Error("clearTimeout has not been defined")}function s(e){if(n===setTimeout)return setTimeout(e,0);if((n===a||!n)&&setTimeout)return n=setTimeout,setTimeout(e,0);try{return n(e,0)}catch(r){try{return n.call(null,e,0)}catch(r){return n.call(this,e,0)}}}!function(){try{n="function"==typeof setTimeout?setTimeout:a}catch(e){n=a}try{t="function"==typeof clearTimeout?clearTimeout:i}catch(e){t=i}}();var c,u=[],l=!1,f=-1;function p(){l&&c&&(l=!1,c.length?u=c.concat(u):f=-1,u.length&&h())}function h(){if(!l){var e=s(p);l=!0;for(var r=u.length;r;){for(c=u,u=[];++f<r;)c&&c[f].run();f=-1,r=u.length}c=null,l=!1,function(e){if(t===clearTimeout)return clearTimeout(e);if((t===i||!t)&&clearTimeout)return t=clearTimeout,clearTimeout(e);try{t(e)}catch(r){try{return t.call(null,e)}catch(r){return t.call(this,e)}}}(e)}}function d(e,r){this.fun=e,this.array=r}function y(){}o.nextTick=function(e){var r=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)r[n-1]=arguments[n];u.push(new d(e,r)),1!==u.length||l||s(h)},d.prototype.run=function(){this.fun.apply(null,this.array)},o.title="browser",o.browser=!0,o.env={},o.argv=[],o.version="",o.versions={},o.on=y,o.addListener=y,o.once=y,o.off=y,o.removeListener=y,o.removeAllListeners=y,o.emit=y,o.prependListener=y,o.prependOnceListener=y,o.listeners=function(e){return[]},o.binding=function(e){throw new Error("process.binding is not supported")},o.cwd=function(){return"/"},o.chdir=function(e){throw new Error("process.chdir is not supported")},o.umask=function(){return 0}},function(e,r,n){"use strict";function t(e,r,t,o){var a=n(18);return new Promise(function(n,i){try{var s=a.request({method:"WEBWIRE",protocol:e,hostname:r,port:t,path:o,json:!0},function(e){if(200!==e.statusCode){var r=new Error("Unexpected response status: ".concat(e.statusCode));return r.errType="disconnected",void n({err:r})}var t="";e.on("data",function(e){t+=e}),e.on("end",function(){n({metadata:JSON.parse(t)})})});s.on("error",function(e){var r=new Error("Failed reading endpoint metadata: ".concat(e.message));r.errType="disconnected",n({err:r})}),s.end()}catch(e){i(e)}})}function o(e,r,n,t){return new Promise(function(o,a){try{var i="".concat(e,"://").concat(r,":").concat(n);t&&(i="".concat(i).concat(t));var s=new XMLHttpRequest;s.open("WEBWIRE",i,!0),s.onload=function(){if(4!==s.readyState){var e=new Error("Unexpected ready state: ".concat(s.readyState));return e.errType="disconnected",void o({err:e})}if(200!==s.status){var r=new Error("Unexpected response status: ".concat(s.status));return r.errType="disconnected",void o({err:r})}o({metadata:JSON.parse(s.responseText)})},s.onerror=function(){var e=new Error("Unexpected error");e.errType="disconnected",o({err:e})},s.send()}catch(e){a(e)}})}n.d(r,"b",function(){return t}),n.d(r,"a",function(){return o})},function(e,r,n){(function(r){r.browser?e.exports=function(e){var r=new WebSocket(e);Object.defineProperty(this,"onOpen",{value:function(e){r.onopen=e},writable:!1}),Object.defineProperty(this,"onError",{value:function(e){r.onerror=e},writable:!1}),Object.defineProperty(this,"onMessage",{value:function(e){r.onmessage=function(r){return e(r.data)}},writable:!1}),Object.defineProperty(this,"onClose",{value:function(e){r.onclose=function(r){return e(r.code)}},writable:!1}),Object.defineProperty(this,"send",{value:function(e){r.send(e)},writable:!1})}:e.exports=function(e){var r=new WebSocket(e);Object.defineProperty(this,"onOpen",{value:function(e){r.on("open",e)},writable:!1}),Object.defineProperty(this,"onError",{value:function(e){},writable:!1}),Object.defineProperty(this,"onMessage",{value:function(e){r.on("message",e)},writable:!1}),Object.defineProperty(this,"onClose",{value:function(e){r.on("close",e)},writable:!1}),Object.defineProperty(this,"send",{value:function(e){r.send(e)},writable:!1})}}).call(this,n(6))},function(e,r,n){"use strict";n.d(r,"a",function(){return s});var t=n(0),o=n(4),a=n(5);function i(e){return(i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function s(e,r,n){if(null==r)throw new Error("Missing request payload");if(null==e&&(e=""),e.length>255)throw new Error("Request name too long (".concat(e.length,"), max 255"));var s,c=Object(o.a)();if("string"==typeof r&&"utf8"===n)s=function(e,r,n){var o=Object(a.a)(n),i=10+r.length,s=new ArrayBuffer(i+o.length),c=new Uint8Array(s,0,i);c[0]=t.b.RequestUtf8;for(var u=e.bytes,l=1;l<9;l++)c[l]=u[l-1];c[9]=r.length;for(var f=0;f<r.length;f++){var p=r.charCodeAt(f);if(p<32||p>126)throw new Error("Unsupported name character (".concat(p,")"));c[10+f]=r.charCodeAt(f)}for(var h=new Uint8Array(s,i,o.length),d=0;d<o.length;d++)h[d]=o[d];return s}(c,e,r);else{if("string"!=typeof r||null!=n)throw new Error("Unsupported request payload type: ".concat(i(r)));s=function(e,r,n){var o=0;null!=r&&r.length%2!=0&&(o=1);var a=10+r.length+o,i=new ArrayBuffer(a+2*n.length),s=new Uint8Array(i,0,a);s[0]=t.b.RequestUtf16;for(var c=e.bytes,u=1;u<9;u++)s[u]=c[u-1];s[9]=r.length;for(var l=0;l<r.length;l++){var f=r.charCodeAt(l);if(f<32||f>126)throw new Error("Unsupported name character (".concat(f,")"));s[10+l]=r.charCodeAt(l)}for(var p=new Uint16Array(i,a,n.length),h=0;h<n.length;h++)p[h]=n.charCodeAt(h);return i}(c,e,r)}Object.defineProperty(this,"bytes",{get:function(){return new Uint8Array(s)}}),Object.defineProperty(this,"id",{get:function(){return c}})}},function(e,r,n){"use strict";n.d(r,"a",function(){return i});var t=n(0),o=n(5);function a(e){return(a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function i(e,r,n){if(null==e&&(e=""),null==r)throw new Error("Missing signal payload");var i;if("string"==typeof r&&"utf8"===n){var s=Object(o.a)(r),c=2+e.length;i=new ArrayBuffer(c+s.length);var u=new Uint8Array(i,0,c);u[0]=t.b.SignalUtf8,u[1]=e.length;for(var l=0;l<e.length;l++)u[2+l]=e.charCodeAt(l);for(var f=new Uint8Array(i,c,s.length),p=0;p<s.length;p++)f[p]=s[p]}else{if("string"!=typeof r||null!=n)throw new Error("Unsupported signal payload type: ".concat(a(r)));var h=!1;e.length%2!=0&&(h=!0);var d=2+e.length+(h?1:0);i=new ArrayBuffer(d+2*r.length);var y=new Uint8Array(i,0,d);y[0]=t.b.SignalUtf16,y[1]=e.length;for(var b=0;b<e.length;b++)y[2+b]=e.charCodeAt(b);for(var g=new Uint16Array(i,d,r.length),v=0;v<r.length;v++)g[v]=r.charCodeAt(v)}Object.defineProperty(this,"bytes",{get:function(){return new Uint8Array(i)}})}},function(e,r,n){"use strict";(function(e){var t=n(2),o=n(12),a=n(0);function i(e){if(e.length<1)return{err:new Error("Invalid message, too short")};var r,n="binary",i=e[0];switch(i){case a.b.SessionCreated:r=function(e){return e.length<a.a.SessionCreated?{err:new Error("Invalid session creation notification message, "+"too short (".concat(e.length," / ").concat(a.a.SessionCreated,")"))}:{session:JSON.parse(Object(t.a)(e.subarray(1)))}}(e);break;case a.b.SessionClosed:r=function(e){return e.length!==a.a.SessionClosed?{err:new Error("Invalid session closure notification message")}:{}}(e);break;case a.b.SignalBinary:r=function(e){if(e.length<a.a.Signal)return{err:new Error("Invalid signal (Binary) message, too short "+"(".concat(e.length," / ").concat(a.a.Signal,")"))};var r=e.subarray(1,2)[0],n=2+r;return e.length<a.a.Signal+r?{err:new Error("Invalid signal (Binary) message, too short for full name"+"(".concat(r,") and the minimum payload (1)"))}:r>0?{name:String.fromCharCode.apply(null,e.subarray(2,n)),payload:e.subarray(n)}:{payload:e.subarray(2)}}(e);break;case a.b.SignalUtf8:n="utf8",r=function(e){if(e.length<a.a.Signal)return{err:new Error("Invalid signal (UTF8) message, too short "+"(".concat(e.length," / ").concat(a.a.Signal,")"))};var r=e.subarray(1,2)[0],n=2+r;return e.length<a.a.Signal+r?{err:new Error("Invalid signal (UTF8) message, "+"too short for full name (".concat(r,") ")+"and the minimum payload (1)")}:r>0?{name:String.fromCharCode.apply(null,e.subarray(2,n)),payload:Object(t.a)(e.subarray(n))}:{payload:Object(t.a)(e.subarray(2))}}(e);break;case a.b.SignalUtf16:n="utf16",r=function(e){if(e.length<a.a.SignalUtf16)return{err:new Error("Invalid signal (UTF16) message, too short "+"(".concat(e.length," / ").concat(a.a.SignalUtf16,")"))};if(e.length%2!=0)return{err:new Error("Unaligned UTF16 encoded signal message "+"(length: ".concat(e.length,", probably missing header padding)"))};var r=e.subarray(1,2)[0],n=a.a.SignalUtf16+r,t=2+r;return r%2!=0&&(n++,t++),e.length<n?{err:new Error("Invalid signal (UTF16) message, too short for full name "+"(".concat(r,") and the minimum payload (2)"))}:r>0?{name:String.fromCharCode.apply(null,new Uint8Array(e,2,2+r)),payload:String.fromCharCode.apply(null,new Uint16Array(e.subarray(t)))}:{payload:String.fromCharCode.apply(null,new Uint16Array(e.subarray(2)))}}(e);break;case a.b.ReplyShutdown:r=function(e){if(e.length<a.a.ReplyShutdown)return{err:new Error("Invalid shutdown error message, too short "+"(".concat(e.length," / ").concat(a.a.ReplyShutdown,")"))};var r=new Error("Server is currently being shutdown and won't process the request");return r.errType="shutdown",{id:e.subarray(1,9),reqError:r}}(e);break;case a.b.ReplyInternalError:r=function(e){if(e.length<a.a.ReplyInternalError)return{err:new Error("Invalid internal error message, too short "+"(".concat(e.length," / ").concat(a.a.ReplyInternalError,")"))};var r=new Error("Request failed due to an internal server error");return r.errType="internal",{id:e.subarray(1,9),reqError:r}}(e);break;case a.b.SessionNotFound:r=function(e){if(e.length<a.a.SessionNotFound)return{err:new Error("Invalid session not found error message, too short "+"(".concat(e.length," / ").concat(a.a.SessionNotFound,")"))};var r=new Error("Requested session wasn't found");return r.errType="session_not_found",{id:e.subarray(1,9),reqError:r}}(e);break;case a.b.MaxSessConnsReached:r=function(e){if(e.length<a.a.MaxSessConnsReached)return{err:new Error("Invalid max-session-connections-reached error message, too short "+"(".concat(e.length," / ").concat(a.a.MaxSessConnsReached,")"))};var r=new Error("Maximum concurrent connections reached for requested session");return r.errType="max_sess_conns_reached",{id:e.subarray(1,9),reqError:r}}(e);break;case a.b.SessionsDisabled:r=function(e){if(e.length<a.a.SessionsDisabled)return{err:new Error("Invalid sessions disabled message, too short "+"(".concat(e.length," / ").concat(a.a.SessionsDisabled,")"))};var r=new Error("Sessions are disabled for this server");return r.errType="sessions_disabled",{id:e.subarray(1,9),reqError:r}}(e);break;case a.b.ErrorReply:r=function(e){if(e.length<a.a.ErrorReply)return{err:new Error("Invalid error reply message, too short "+"(".concat(e.length," / ").concat(a.a.ErrorReply,")"))};var r=e.subarray(9,10)[0];if(r<1)return{err:new Error("Invalid error code length in error reply message")};if(e.length<a.a.ErrorReply+r-1)return{err:new Error("Invalid error reply message, "+"too short for error code (".concat(r,")"))};var n=new Error(Object(t.a)(e.subarray(10+r)));return n.code=Object(o.a)(e.subarray(10,10+r)),{id:e.subarray(1,9),reqError:n}}(e);break;case a.b.ReplyProtocolError:r=function(e){if(e.length<a.a.ReplyProtocolError)return{err:new Error("Invalid protocol error reply message, too short: "+"(".concat(e.length," / ").concat(a.a.ReplyProtocolError,")"))};var r=new Error("Protocol error");return r.errType="protocol_error",{id:e.subarray(1,9),reqError:r}}(e);break;case a.b.ReplyBinary:r=function(e){if(e.length<a.a.Reply)return{err:new Error("Invalid reply (Binary) message, too short "+"(".concat(e.length," / ").concat(a.a.Reply,")"))};var r=null;return e.length>a.a.Reply&&(r=e.subarray(9)),{id:e.subarray(1,9),payload:r}}(e);break;case a.b.ReplyUtf8:n="utf8",r=function(e){if(e.length<a.a.Reply)return{err:new Error("Invalid reply (UTF8) message, too short "+"(".concat(e.length," / ").concat(a.a.Reply,")"))};var r=null;return e.length>a.a.Reply&&(r=Object(t.a)(e.subarray(9))),{id:e.subarray(1,9),payload:r}}(e);break;case a.b.ReplyUtf16:n="utf16",r=function(e){if(e.length<a.a.ReplyUtf16)return{err:new Error("Invalid reply (UTF16) message, too short "+"(".concat(e.length," / ").concat(a.a.ReplyUtf16,")"))};if(e.length%2!=0)return{err:new Error("Unaligned UTF16 encoded reply message "+"(length: ".concat(e.length,", probably missing header padding)"))};var r=null;return e.length>a.a.ReplyUtf16&&(r=String.fromCharCode.apply(null,new Uint16Array(e,10,e.length-5))),{id:e.subarray(1,9),payload:r}}(e);break;default:r={err:new Error("Unsupported message type: ".concat(i))}}return null!=r.err?{err:r.err}:{type:i,payloadEncoding:n,msg:r}}r.a=function(r){return new Promise(function(n,t){try{if(e.browser){var o=new FileReader;o.onerror=function(e){t(e.target.error)},o.onload=function(){n(i(new Uint8Array(this.result)))},o.readAsArrayBuffer(r)}else n(i(new Uint8Array(r.buffer,r.byteOffset,r.byteLength/Uint8Array.BYTES_PER_ELEMENT)))}catch(e){t(e)}})}}).call(this,n(6))},function(e,r,n){"use strict";function t(e){for(var r="",n=0;n<e.length;n++)r+=String.fromCharCode(e[n]);return r}n.d(r,"a",function(){return t})},function(e,r,n){"use strict";n.d(r,"a",function(){return a});var t=n(4);function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function a(e,r){if(null==e||e<0||e>255)throw new Error("Missing or invalid message type ".concat(e));if(null!=r&&!(r instanceof Uint8Array))throw new Error("Invalid request payload: ".concat(o(r)));var n=null!=r?r.length:0,a=new ArrayBuffer(9+n),i=new Uint8Array(a,0,9+n);i[0]=e;for(var s=Object(t.a)(),c=s.bytes,u=1;u<9;u++)i[u]=c[u-1];if(null!=r)for(var l=0;l<n;l++)i[9+l]=r[l];Object.defineProperty(this,"bytes",{get:function(){return new Uint8Array(a)}}),Object.defineProperty(this,"id",{get:function(){return s}})}},function(e,r,n){"use strict";var t=/^((http|https):\/\/)?(localhost|((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(\.|$)){3}((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?))|(([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9-]*[a-zA-Z0-9])\.)*([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9-]*[A-Za-z0-9]))(:([0-9]{1,4}|[1-5][0-9]{4}|6[0-4][0-9]{3}|65[0-4][0-9]{2}|655[0-2][0-9]|6553[0-5]))?\/*(\/([^/]+)\/?.*$)?$/;r.a=function(e){if("string"!=typeof e||e.length<1)throw new Error("Invalid WebWire server host");return function(e){var r=t.exec(e);if(null==r)throw new Error("Invalid server host string: ".concat(e));var n=r[2]||"http",o=r[3],a=parseInt(r[13]||80),i=r[14];return"https"===n&&null==r[13]&&(a=443),{protocol:n,hostname:o,port:a,path:i}}(e)}},function(e,r,n){"use strict";n.r(r),function(e){n.d(r,"default",function(){return w});var t=n(1),o=n.n(t),a=n(8),i=n.n(a),s=n(0),c=n(9),u=n(10),l=n(3),f=n(11),p=n(13),h=n(7),d=n(14);function y(e,r,n,t,o,a,i){try{var s=e[a](i),c=s.value}catch(e){return void n(e)}s.done?r(c):Promise.resolve(c).then(t,o)}function b(e){return function(){var r=this,n=arguments;return new Promise(function(t,o){var a=e.apply(r,n);function i(e){y(a,t,o,i,s,"next",e)}function s(e){y(a,t,o,i,s,"throw",e)}i(void 0)})}}var g="1.4";var v={Disabled:0,Disconnected:1,Connected:2,Connecting:3};function w(r,n){var t=Object(d.a)(r),a=t.protocol,y=t.hostname,w=t.port,m=t.path,S=t.err;if(S)throw S;var E=function(e,r,n,t){var o="".concat("https"===e?"wss":"ws","://").concat(r,":").concat(n);return t?"".concat(o).concat(t):o}(a,y,w,m);null==n&&(n={});var x,k=function(e,r,n){var t="".concat(e,":").concat(r);return n?"".concat(t).concat(n):t}(y,w,m);e.browser&&(x=localStorage.getItem(k)),null!=x?(x=JSON.parse(x)).session=new l.a(x.session):x={};var C=n.defaultReqTimeout||6e4,R=n.reconnectionInterval||2e3,O=n.autoconnect||!0,U={},j=x.session?{key:x.session}:null,P=null,T=v.Disconnected,A=null,I=null,L=function(e){var r=function(){},n=function(){},t=function(){},o=function(){},a=function(){};if(null==e||null==e.handlers)return{onSignal:r,onSessionCreated:n,onSessionClosed:t,onDisconnected:o,onConnected:a};var i=e.handlers;return i.onSignal instanceof Function&&(r=i.onSignal),i.onSessionCreated instanceof Function&&(n=i.onSessionCreated),i.onSessionClosed instanceof Function&&(t=i.onSessionClosed),i.onDisconnected instanceof Function&&(o=i.onDisconnected),i.onConnected instanceof Function&&(a=i.onConnected),{onSignal:r,onSessionCreated:n,onSessionClosed:t,onDisconnected:o,onConnected:a}}(n),_=L.onSignal,q=L.onSessionCreated,W=L.onSessionClosed,D=L.onDisconnected,F=L.onConnected;function N(e){var r=new l.a(e.k);j={key:r,creationDate:new Date(e.c),info:e.i};var n=JSON.stringify({session:r.string});localStorage.setItem(k,n),q({key:r,creationDate:new Date(e.c),info:e.i})}function B(e){var r=U[e.id];r&&r.fail({code:e.error.code,message:e.error.message})}function M(e){var r=U[e.id];r&&r.fulfill({encoding:e.encoding,payload:e.payload})}function z(e){return G.apply(this,arguments)}function G(){return(G=b(o.a.mark(function e(r){var n,t,a,i,c;return o.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!(r.size<1)){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,Object(f.a)(r);case 4:if(n=e.sent,t=n.type,a=n.msg,i=n.payloadEncoding,null==(c=n.err)){e.next=12;break}return console.error("WebWire: failed parsing message: ".concat(c)),e.abrupt("return");case 12:e.t0=t,e.next=e.t0===s.b.ReplyBinary?15:e.t0===s.b.ReplyUtf8?15:e.t0===s.b.ReplyUtf16?15:e.t0===s.b.ReplyShutdown?17:e.t0===s.b.ReplyInternalError?17:e.t0===s.b.SessionNotFound?17:e.t0===s.b.MaxSessConnsReached?17:e.t0===s.b.ErrorReply?17:e.t0===s.b.SignalBinary?19:e.t0===s.b.SignalUtf8?19:e.t0===s.b.SignalUtf16?19:e.t0===s.b.SessionCreated?21:e.t0===s.b.SessionClosed?23:25;break;case 15:return M({id:a.id,encoding:i,payload:a.payload}),e.abrupt("break",27);case 17:return B({id:a.id,error:a.reqError}),e.abrupt("break",27);case 19:return _({name:a.name,encoding:i,payload:a.payload}),e.abrupt("break",27);case 21:return N(a.session),e.abrupt("break",27);case 23:return j=null,W(),e.abrupt("break",27);case 25:return console.warn("WebWire: strange message type received:",t),e.abrupt("break",27);case 27:case"end":return e.stop()}},e,this)}))).apply(this,arguments)}function J(){return Z.apply(this,arguments)}function Z(){return(Z=b(o.a.mark(function r(){var n,t,i,s,c,u;return o.a.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.prev=0,n=e.browser?h.a:h.b,r.next=4,n(a,y,w,m);case 4:if(t=r.sent,i=t.metadata,!(s=t.err)){r.next=9;break}return r.abrupt("return",s);case 9:if((c=i["protocol-version"])===g){r.next=14;break}return(u=new Error("Unsupported protocol version: ".concat(c," ")+"(supported: ".concat(g,")"))).errType="incomp",r.abrupt("return",u);case 14:r.next=19;break;case 16:return r.prev=16,r.t0=r.catch(0),r.abrupt("return",r.t0);case 19:case"end":return r.stop()}},r,this,[[0,16]])}))).apply(this,arguments)}function Y(e){return new Promise(function(r){return setTimeout(r,e)})}function $(e){return H.apply(this,arguments)}function H(){return(H=b(o.a.mark(function e(r){return o.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(T!==v.Connecting){e.next=4;break}return e.abrupt("return",new Promise(function(e,r){I.then(e).catch(r)}));case 4:if(T===v.Disconnected){e.next=6;break}return e.abrupt("return",Promise.resolve());case 6:if(O){e.next=8;break}return e.abrupt("return",V());case 8:return e.abrupt("return",new Promise(function(e,n){if(null!=A)return r>0&&setTimeout(function(){var r=new Error("Auto-connect attempt timed out");r.errType="timeout",e(r)},r),void A.then(e);A=new Promise(function(){var e=b(o.a.mark(function e(t){var a;return o.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,!(r>0)){e.next=4;break}return setTimeout(function(){var e=new Error("Auto-reconnect attempt timed out");e.errType="timeout",t(e)},r),e.abrupt("return");case 4:return e.next=7,V();case 7:if(null!=(a=e.sent)){e.next=14;break}return t(),A=null,e.abrupt("return");case 14:if("disconnected"!==a.errType){e.next=20;break}return e.next=17,Y(R);case 17:return e.abrupt("continue",4);case 20:return t({err:a}),A=null,e.abrupt("return");case 23:e.next=4;break;case 25:e.next=30;break;case 27:e.prev=27,e.t0=e.catch(0),n(e.t0);case 30:case"end":return e.stop()}},e,this,[[0,27]])}));return function(r){return e.apply(this,arguments)}}())}));case 9:case"end":return e.stop()}},e,this)}))).apply(this,arguments)}function K(e,r,n,t,a){return new Promise(function(){var i=b(o.a.mark(function i(s,u){var l,f,h,d,y,b;return o.a.wrap(function(o){for(;;)switch(o.prev=o.next){case 0:return o.prev=0,l=e&&!r?new p.a(e,n):new c.a(r,n,t),f=l.id.bytes,h=a||C,d=setTimeout(function(){delete U[f],d=null;var e=new Error("Request timed out");e.errType="timeout",s({err:e})},h),o.next=7,$(h);case 7:if(null==(y=o.sent)){o.next=10;break}return o.abrupt("return",s({err:y}));case 10:b={fulfill:function(e){null!=d&&(delete U[f],clearTimeout(d),s({reply:e}))},fail:function(e){null!=d&&(delete U[f],clearTimeout(d),s({err:e}))}},U[f]=b,P.send(l.bytes),o.next=18;break;case 15:o.prev=15,o.t0=o.catch(0),u(o.t0);case 18:case"end":return o.stop()}},i,this,[[0,15]])}));return function(e,r){return i.apply(this,arguments)}}())}function X(e){return Q.apply(this,arguments)}function Q(){return(Q=b(o.a.mark(function e(r){var n,t,a,i;return o.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,K(s.b.RestoreSession,null,r);case 2:if(n=e.sent,t=n.reply,null==(a=n.err)){e.next=10;break}return console.warn("WebWire client: couldn't restore session:",a),j=null,localStorage.removeItem(k),e.abrupt("return",a);case 10:i=JSON.parse(t.payload),j={key:new l.a(i.k),creationDate:new Date(i.c),info:i.i};case 12:case"end":return e.stop()}},e,this)}))).apply(this,arguments)}function V(){return T===v.Connected?Promise.resolve():null!=I?new Promise(function(e,r){I.then(e).catch(r)}):I=new Promise(function(){var e=b(o.a.mark(function e(r,n){var t,a;return o.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return T=v.Connecting,e.prev=1,e.next=4,J();case 4:if(null==(t=e.sent)){e.next=12;break}if("incomp"!==t.errType){e.next=8;break}throw t;case 8:return(a=new Error("disconnected")).errType="disconnected",I=null,e.abrupt("return",r(a));case 12:(P=new i.a(E)).onOpen(b(o.a.mark(function e(){var n;return o.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(I=null,T=v.Connected,null!=j){e.next=5;break}return F(),e.abrupt("return",r());case 5:return e.next=7,X(j.key.bytes);case 7:null!=(n=e.sent)&&console.warn("WebWire: couldn't restore session on reconnection",n),F(),r();case 11:case"end":return e.stop()}},e,this)}))),P.onError(function(e){I=null,console.error("WebWire client error:",e);var n=new Error("WebSocket error: ".concat(e));n.errType="disconnected",r(n)}),P.onMessage(function(e){return z(e)}),P.onClose(function(){var e=b(o.a.mark(function e(r){var n;return o.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return T=v.Disconnected,1e3!==r&&1001!==r&&console.warn("WebWire: abnormal closure error: code:",r),D(),e.next=5,$(0);case 5:null!=(n=e.sent)&&console.error("WebWire: autoconnect failed:",n);case 7:case"end":return e.stop()}},e,this)}));return function(r){return e.apply(this,arguments)}}()),e.next=22;break;case 19:e.prev=19,e.t0=e.catch(1),n(e.t0);case 22:case"end":return e.stop()}},e,this,[[1,19]])}));return function(r,n){return e.apply(this,arguments)}}())}function ee(){return(ee=b(o.a.mark(function e(r,n,t){var a,i;return o.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return a=new u.a(r,n,t),e.next=3,V();case 3:if(null==(i=e.sent)){e.next=6;break}return e.abrupt("return",i);case 6:P.send(a.bytes);case 7:case"end":return e.stop()}},e,this)}))).apply(this,arguments)}function re(){return(re=b(o.a.mark(function e(r){var n,t;return o.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r instanceof l.a){e.next=2;break}return e.abrupt("return",new Error("Expected session key to be an instance of SessionKey"));case 2:if(!j){e.next=4;break}return e.abrupt("return",new Error("Can't restore session if another one is already active"));case 4:return e.next=6,V();case 6:if(null==(n=e.sent)){e.next=9;break}return e.abrupt("return",n);case 9:return e.next=11,X(r.bytes);case 11:null!=(t=e.sent)&&console.warn("WebWire: couldn't restore session by key\n\t\t\t\t\t(".concat(r.string,") : ").concat(t));case 13:case"end":return e.stop()}},e,this)}))).apply(this,arguments)}function ne(){return(ne=b(o.a.mark(function e(){var r,n;return o.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(j&&!(T<v.Connected)){e.next=3;break}return j=null,e.abrupt("return");case 3:return e.next=5,K(s.b.CloseSession);case 5:if(r=e.sent,null==(n=r.err)){e.next=9;break}return e.abrupt("return",n);case 9:j=null,localStorage.removeItem(k);case 11:case"end":return e.stop()}},e,this)}))).apply(this,arguments)}Object.defineProperty(this,"connect",{value:V}),Object.defineProperty(this,"request",{value:function(e,r,n,t){return K(null,e,r,n,t)}}),Object.defineProperty(this,"signal",{value:function(e,r,n){return ee.apply(this,arguments)}}),Object.defineProperty(this,"restoreSession",{value:function(e){return re.apply(this,arguments)}}),Object.defineProperty(this,"closeSession",{value:function(){return ne.apply(this,arguments)}}),Object.defineProperty(this,"close",{value:function(){P.close(),P=null,T=v.Disabled}}),Object.defineProperty(this,"status",{get:function(){switch(T){case v.Disabled:return"disabled";case v.Disconnected:return"disconnected";case v.Connected:return"connected";case v.Connecting:return"connecting"}return"invalid_client_status"}}),Object.defineProperty(this,"session",{get:function(){if(j)return{key:j.key,creationDate:j.creationDate?new Date(j.creationDate.getTime()):null,info:j.info?JSON.parse(JSON.stringify(j.info)):null}}}),Object.defineProperty(this,"pendingRequests",{get:function(){return U.length}}),Object.freeze(this),$(0).then(function(e){null!=e&&console.error("WebWire: autoconnect failed:",e)}).catch(function(e){console.warn("WebWire: autoconnect failed:",e)})}}.call(this,n(6))},function(e,r,n){var t=function(){return this||"object"==typeof self&&self}()||Function("return this")(),o=t.regeneratorRuntime&&Object.getOwnPropertyNames(t).indexOf("regeneratorRuntime")>=0,a=o&&t.regeneratorRuntime;if(t.regeneratorRuntime=void 0,e.exports=n(17),o)t.regeneratorRuntime=a;else try{delete t.regeneratorRuntime}catch(e){t.regeneratorRuntime=void 0}},function(e,r){!function(r){"use strict";var n,t=Object.prototype,o=t.hasOwnProperty,a="function"==typeof Symbol?Symbol:{},i=a.iterator||"@@iterator",s=a.asyncIterator||"@@asyncIterator",c=a.toStringTag||"@@toStringTag",u="object"==typeof e,l=r.regeneratorRuntime;if(l)u&&(e.exports=l);else{(l=r.regeneratorRuntime=u?e.exports:{}).wrap=m;var f="suspendedStart",p="suspendedYield",h="executing",d="completed",y={},b={};b[i]=function(){return this};var g=Object.getPrototypeOf,v=g&&g(g(T([])));v&&v!==t&&o.call(v,i)&&(b=v);var w=k.prototype=E.prototype=Object.create(b);x.prototype=w.constructor=k,k.constructor=x,k[c]=x.displayName="GeneratorFunction",l.isGeneratorFunction=function(e){var r="function"==typeof e&&e.constructor;return!!r&&(r===x||"GeneratorFunction"===(r.displayName||r.name))},l.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,k):(e.__proto__=k,c in e||(e[c]="GeneratorFunction")),e.prototype=Object.create(w),e},l.awrap=function(e){return{__await:e}},C(R.prototype),R.prototype[s]=function(){return this},l.AsyncIterator=R,l.async=function(e,r,n,t){var o=new R(m(e,r,n,t));return l.isGeneratorFunction(r)?o:o.next().then(function(e){return e.done?e.value:o.next()})},C(w),w[c]="Generator",w[i]=function(){return this},w.toString=function(){return"[object Generator]"},l.keys=function(e){var r=[];for(var n in e)r.push(n);return r.reverse(),function n(){for(;r.length;){var t=r.pop();if(t in e)return n.value=t,n.done=!1,n}return n.done=!0,n}},l.values=T,P.prototype={constructor:P,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=n,this.done=!1,this.delegate=null,this.method="next",this.arg=n,this.tryEntries.forEach(j),!e)for(var r in this)"t"===r.charAt(0)&&o.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=n)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var r=this;function t(t,o){return s.type="throw",s.arg=e,r.next=t,o&&(r.method="next",r.arg=n),!!o}for(var a=this.tryEntries.length-1;a>=0;--a){var i=this.tryEntries[a],s=i.completion;if("root"===i.tryLoc)return t("end");if(i.tryLoc<=this.prev){var c=o.call(i,"catchLoc"),u=o.call(i,"finallyLoc");if(c&&u){if(this.prev<i.catchLoc)return t(i.catchLoc,!0);if(this.prev<i.finallyLoc)return t(i.finallyLoc)}else if(c){if(this.prev<i.catchLoc)return t(i.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return t(i.finallyLoc)}}}},abrupt:function(e,r){for(var n=this.tryEntries.length-1;n>=0;--n){var t=this.tryEntries[n];if(t.tryLoc<=this.prev&&o.call(t,"finallyLoc")&&this.prev<t.finallyLoc){var a=t;break}}a&&("break"===e||"continue"===e)&&a.tryLoc<=r&&r<=a.finallyLoc&&(a=null);var i=a?a.completion:{};return i.type=e,i.arg=r,a?(this.method="next",this.next=a.finallyLoc,y):this.complete(i)},complete:function(e,r){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&r&&(this.next=r),y},finish:function(e){for(var r=this.tryEntries.length-1;r>=0;--r){var n=this.tryEntries[r];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),j(n),y}},catch:function(e){for(var r=this.tryEntries.length-1;r>=0;--r){var n=this.tryEntries[r];if(n.tryLoc===e){var t=n.completion;if("throw"===t.type){var o=t.arg;j(n)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(e,r,t){return this.delegate={iterator:T(e),resultName:r,nextLoc:t},"next"===this.method&&(this.arg=n),y}}}function m(e,r,n,t){var o=r&&r.prototype instanceof E?r:E,a=Object.create(o.prototype),i=new P(t||[]);return a._invoke=function(e,r,n){var t=f;return function(o,a){if(t===h)throw new Error("Generator is already running");if(t===d){if("throw"===o)throw a;return A()}for(n.method=o,n.arg=a;;){var i=n.delegate;if(i){var s=O(i,n);if(s){if(s===y)continue;return s}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(t===f)throw t=d,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);t=h;var c=S(e,r,n);if("normal"===c.type){if(t=n.done?d:p,c.arg===y)continue;return{value:c.arg,done:n.done}}"throw"===c.type&&(t=d,n.method="throw",n.arg=c.arg)}}}(e,n,i),a}function S(e,r,n){try{return{type:"normal",arg:e.call(r,n)}}catch(e){return{type:"throw",arg:e}}}function E(){}function x(){}function k(){}function C(e){["next","throw","return"].forEach(function(r){e[r]=function(e){return this._invoke(r,e)}})}function R(e){var r;this._invoke=function(n,t){function a(){return new Promise(function(r,a){!function r(n,t,a,i){var s=S(e[n],e,t);if("throw"!==s.type){var c=s.arg,u=c.value;return u&&"object"==typeof u&&o.call(u,"__await")?Promise.resolve(u.__await).then(function(e){r("next",e,a,i)},function(e){r("throw",e,a,i)}):Promise.resolve(u).then(function(e){c.value=e,a(c)},function(e){return r("throw",e,a,i)})}i(s.arg)}(n,t,r,a)})}return r=r?r.then(a,a):a()}}function O(e,r){var t=e.iterator[r.method];if(t===n){if(r.delegate=null,"throw"===r.method){if(e.iterator.return&&(r.method="return",r.arg=n,O(e,r),"throw"===r.method))return y;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return y}var o=S(t,e.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,y;var a=o.arg;return a?a.done?(r[e.resultName]=a.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=n),r.delegate=null,y):a:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,y)}function U(e){var r={tryLoc:e[0]};1 in e&&(r.catchLoc=e[1]),2 in e&&(r.finallyLoc=e[2],r.afterLoc=e[3]),this.tryEntries.push(r)}function j(e){var r=e.completion||{};r.type="normal",delete r.arg,e.completion=r}function P(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(U,this),this.reset(!0)}function T(e){if(e){var r=e[i];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var t=-1,a=function r(){for(;++t<e.length;)if(o.call(e,t))return r.value=e[t],r.done=!1,r;return r.value=n,r.done=!0,r};return a.next=a}}return{next:A}}function A(){return{value:n,done:!0}}}(function(){return this||"object"==typeof self&&self}()||Function("return this")())},function(r,n){r.exports=e}])});